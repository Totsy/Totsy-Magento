<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */
?>
<?php
/**
 * Product list template
 *
 * @see Mage_Catalog_Block_Product_List
 */
?>
<?php
    $_productCollection=$this->getLoadedProductCollection();
    $_cookietCode = Mage::helper('categoryevent')->getPreviewCookieName();
    $_cookietEnValue = Mage::getModel('core/cookie')->get($_cookietCode);
    $_cookietDeValue = Mage::helper('categoryevent')->getPreviewCookieDecryptedCode($_cookietEnValue);
    $_adminPass = false;
    $_currentCategory = Mage::getSingleton('catalog/layer')->getCurrentCategory();
    $_helper = $this->helper('catalog/output');

	$defaultTimezone = date_default_timezone_get();
	$mageTimezone = Mage::getStoreConfig(Mage_Core_Model_Locale::XML_PATH_DEFAULT_TIMEZONE);
	date_default_timezone_set($mageTimezone);	
	$now = now();
	date_default_timezone_set($defaultTimezone);
	
	if ( strtotime($now) >= strtotime($_currentCategory->getData('event_end_date')) || strtotime($now) < strtotime($_currentCategory->getData('event_start_date'))){
		$timeOutFlag = 1;
	}else {
		$timeOutFlag = 0;
	}
	
	if ( !!$_cookietDeValue && $_cookietDeValue == Harapartners_Categoryevent_Helper_Data::ADMIN_CATEGORY_PREVIEW_CODE ) {
		$timeOutFlag = 0;
		$_adminPass = true;
    }
?>

<?php if( !$_productCollection->count() || $timeOutFlag || !$_adminPass ): ?>
<p class="note-msg"><?php echo $this->__('There are no products matching the selection.') ?></p>
<?php else : ?>
<div class="category-products">
	<?php // Grid Only Mode ?>
	<?php $_collectionSize = $_productCollection->count() ?>
	<?php $_columnCount = 3; //for the elements number will be changed by the filter?>
	<?php //$_columnCount = $this->getColumnCount(); ?>
	<?php $i=0; foreach ($_productCollection as $_product): ?>
		<?php if ( $_product->isSalable() ):?>
		    <?php if ($i++%$_columnCount==0): ?>
		    <ul class="products-grid">
		    <?php endif ?>
		        <li class="item<?php if(($i-1)%$_columnCount==0): ?> first<?php elseif($i%$_columnCount==0): ?> last <?php endif; ?><?php echo ' '.str_replace(',',' ',$_product->getDepartments()) ?>" department="<?php echo str_replace(',',' ',$_product->getDepartments()) ?>">
		        	<ul class="echoShare" 
					data-productname="<?php echo $_product->getName();?>"  
					data-productcap="" 
					data-productdesc="<?php echo $_product->getShortDescription();?>" 
					data-imageclass=""  
					sdata-producturl="<?php echo $_product->getProductUrl(); ?>">
					</ul>
		            <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" class="product-image"><img src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(348,350); ?>" width="300px" height="300px" alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" /></a>
		            <div class="product-info">
		            	<h2 class="product-name"><a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a></h2>
			            <?php if($_product->getRatingSummary()): ?>
			            <?php echo $this->getReviewsSummaryHtml($_product, 'short') ?>
			            <?php endif; ?>
			            <?php echo $this->getPriceHtml($_product, true) ?>
			        </div>
		        </li>
		    <?php if ($i%$_columnCount==0 || $i==$_collectionSize): ?>
		    </ul>
		    <?php endif ?>
		<?php endif;?>
    <?php endforeach ?>
    <?php foreach ($_productCollection as $_product): ?>
		<?php if ( !$_product->isSalable() ):?>
		    <?php if ($i++%$_columnCount==0): ?>
		    <ul class="products-grid">
		    <?php endif ?>
		        <li class="item<?php if(($i-1)%$_columnCount==0): ?> first<?php elseif($i%$_columnCount==0): ?> last <?php endif; ?><?php echo ' '.str_replace(',',' ',$_product->getDepartments()) ?>" department="<?php echo str_replace(',',' ',$_product->getDepartments()) ?>">
		            <img id="out-of-stock" src="<?php echo $this->getSkinUrl('images/soldout.png');?>"/>
		        	<ul class="echoShare" 
					data-productname="<?php echo $_product->getName();?>"  
					data-productcap="" 
					data-productdesc="<?php echo $_product->getDescription();?>" 
					data-imageclass=""  
					sdata-producturl="<?php echo $_product->getProductUrl(); ?>">
					</ul>
		            <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" class="product-image"><img src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(348,350); ?>" width="300px" height="300px" alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" /></a>
		            <div class="product-info">
		            	<h2 class="product-name"><a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a></h2>
			            <?php if($_product->getRatingSummary()): ?>
			            <?php echo $this->getReviewsSummaryHtml($_product, 'short') ?>
			            <?php endif; ?>
			            <?php echo $this->getPriceHtml($_product, true) ?>
			        </div>
		        </li>
		    <?php if ($i%$_columnCount==0 || $i==$_collectionSize): ?>
		    </ul>
		    <?php endif ?>
		<?php endif;?>
    <?php endforeach ?>
    <script type="text/javascript">decorateGeneric($$('ul.products-grid'), ['odd','even','first','last'])</script>
</div>
<?php endif; ?>
<?php Mage::getModel('core/cookie')->delete($_cookietCode);?>
