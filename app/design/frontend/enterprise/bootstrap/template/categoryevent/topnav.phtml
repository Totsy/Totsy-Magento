<?php
/**
 * Harapartners
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Harapartners License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.Harapartners.com/license
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@Harapartners.com so we can send you a copy immediately.
 *
 */

$topNavDataObject = $this->getTopNavDataObject();
$categoryDataArray = $topNavDataObject->getData('category_product_complete_data'); 
$howMany = count($categoryDataArray);
?>

<div class="page-header">
    <h2><?php echo $topNavDataObject->getData('attr_text_label'); ?><span><?php echo ' ( '.$howMany.' Sales Found )';?></span></h2>
</div>

<script type="text/javascript">
shpn='<?php echo $topNavDataObject->getData('attr_text_label'); ?>'
</script>

<?php foreach($categoryDataArray as $category):?>

<div class="events-div">

<?php 
    $timerParam = $category['prepare_timer'];
    $endcount_lc = $timerParam['endcount_lc'];
    $timer = $timerParam['timer'];
?>
<div class="well">
    <h3 class="category-name"><a href="<?php echo Mage::getBaseUrl().$category['category_info']['url_path']; ?>"><?php echo $category['category_info']['name']; ?></a><small class="pull-right"><p class="the-topnav-timer" id="time-layer-<?php echo $timer ?>"></p></small>
    </h3>
    <hr />
    <script type="text/javascript">
        jQuery("#time-layer-<?php echo $timer ?>").countdown({
            date: "<?php echo $endcount_lc; ?>", //Counting TO a date
            htmlTemplate: "<span>Ends in</span><span class='italic'> %{d} <span class=\"cd-time\">Days</span> %{h}<span class=\"cd-time\">:</span>%{m}<span class=\"cd-time\">:</span>%{s}<span class=\"cd-time\"></span></span>",
            onChange: function( event, timer ){
            },
            onComplete: function( event ){
                jQuery(this).html("Completed");
                jQuery(this).parents('.events-div').hide();
            },
            leadingZero: true,
            direction: "down"
        });
    </script>
    <p><?php echo $category['category_info']['description']; ?></p>
    <div class="category-products">
    <ul class="products-grid thumbnails">
        <?php $j=0; ?>
        <?php $nonSalableArray = array();?>
        <?php $i=0; foreach ($category['product_list'] as $_product): ?>
        <?php if (empty($_product['url_path']) || !preg_match('/sales/',$_product['url_path'])){
            $_product['url_path'] = $_product['request_path'];
        } 
        ?>
        <?php if ($_product['is_salable']==1): ?>
        <li class="span2" style="width:143px;">
        <div class="thumbnail">
            <ul class="echoShare" 
            data-productname="<?php echo $_product['name'];?>" 
            data-productcap="" 
            data-productdesc="<?php echo $_product['description'];?>" 
            data-imageclass=""  
            data-producturl="<?php echo $_product['url_path']; ?>">
        </ul>
        <a href="<?php echo Mage::getBaseUrl().$_product['url_path']; ?>" title="<?php echo $_product['name']; ?>" class="product-image"><img src="<?php echo $_product['small_image']; ?>" width="148" alt="<?php echo $_product['name']; ?>" /></a>
        <h5 class="product-name ellipsis">
            <?php echo $_product['name']; ?>
        </h5>
        <?php //echo $this->getPriceHtml($_product, true) ?>
        <div class="price-box">
        <span class="regular-price" id="product-price-<?php echo $_product['entity_id']; ?>">
        <?php $price = (isset($_product['special_price']))?$_product['special_price']:$_product['price']?>
        <span class="price">$<?php echo number_format($price,2,'.',''); ?></span>
        </span>
        </div>
        
        </div>
        </li>
        </li>
        <?php 
            $i++; 
            $j = $i;
                if ($i==5){
            break;
            }
        ?>
        <?php else: ?>
        <?php $nonSalableArray[] = $_product;?>
        <?php endif; ?>
        <?php endforeach; ?>
    </div>
    <li class="item last btn viewAllEvents">
        <a href="<?php echo Mage::getBaseUrl().$category['category_info']['url_path']; ?>">
        <img src="<?php echo $this->getSkinUrl()?>images/btn-viewevents-bug.png" />
        </a>
    </li>
</ul>

<script type="text/javascript">decorateGeneric($$('ul.products-grid'), ['odd','even','first','last'])</script>
<div class="vuall pull-right">View all items from <a href="<?php echo Mage::getBaseUrl().$category['category_info']['url_path']; ?>"><?php echo $category['category_info']['name']; ?></a></div>
</div>
</div>
<?php endforeach ?>